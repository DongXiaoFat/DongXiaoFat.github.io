<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="SurfaceFlinger 之 HWComposer" /><meta name="author" content="DongXiaoFat" /><meta property="og:locale" content="en_US" /><meta name="description" content="SurfaceFlinger 之 HWComposer." /><meta property="og:description" content="SurfaceFlinger 之 HWComposer." /><link rel="canonical" href="https://dongxiaofat.github.io/posts/SurfaceFlinger-HWComposer/" /><meta property="og:url" content="https://dongxiaofat.github.io/posts/SurfaceFlinger-HWComposer/" /><meta property="og:site_name" content="SunMoon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-26T12:45:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="SurfaceFlinger 之 HWComposer" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"SurfaceFlinger 之 HWComposer","dateModified":"2021-02-26T12:45:00+08:00","description":"SurfaceFlinger 之 HWComposer.","datePublished":"2021-02-26T12:45:00+08:00","url":"https://dongxiaofat.github.io/posts/SurfaceFlinger-HWComposer/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://dongxiaofat.github.io/posts/SurfaceFlinger-HWComposer/"},"author":{"@type":"Person","name":"DongXiaoFat"},"@context":"https://schema.org"}</script><title>SurfaceFlinger 之 HWComposer | SunMoon</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/av.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">SunMoon</a></div><div class="site-subtitle font-italic">祖国尚未统一，无心写博客</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-Circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/DongXiaoFat" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github "></i> </a> <a href="https://gitee.com/DongXiaoFat" aria-label="gitee" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-git"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['chuyangdong123','outlook.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>SurfaceFlinger 之 HWComposer</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>SurfaceFlinger 之 HWComposer</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Feb 26, 2021, 12:45 PM +0800" > Feb 26 <i class="unloaded">2021-02-26T12:45:00+08:00</i> </span> by <span class="author"> DongXiaoFat </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2728 words">15 min</span></div></div><div class="post-content"><h1 id="surfaceflinger-之-hwcomposer">SurfaceFlinger 之 HWComposer</h1><blockquote><p>HWC（hwcomposer）是Android中进行窗口（Layer）合成和显示的HAL层模块，其实现是特定于设备的，而且通常由显示设备制造商 (OEM)完成，为SurfaceFlinger服务提供硬件支持。</p></blockquote><blockquote><p>SurfaceFlinger可以使用OpenGL ES合成Layer，这需要占用并消耗GPU资源。大多数GPU都没有针对图层合成进行优化，当SurfaceFlinger通过GPU合成图层时，应用程序无法使用GPU进行自己的渲染。而HWC通过硬件设备进行图层合成，可以减轻GPU的合成压力。</p></blockquote><h2 id="hwcomposer-与-surfaceflinger的联系">HWComposer 与 SurfaceFlinger的联系</h2><ol><li>在 SurfaceFlinger 进行init的时候会去获取HWComposer实例，而这份实例是由SurfaceFlingerFactory 根据servicename去创建，而这个servicename 是被保存在了SurfaceFlingerBE中，在SurfaceFlingerBE初始化的时候去获取”debug.sf.hwc_service_name”属性对应的值，如果没有配置该键，就有用默认值”default”</ol><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="c1">// frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp</span>
<span class="kt">void</span> <span class="n">SufaceFlinger</span><span class="o">::</span><span class="n">init</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">....</span>
    <span class="n">mCompositionEngine</span><span class="o">-&gt;</span><span class="n">setHwComposer</span><span class="p">(</span><span class="n">getFactory</span><span class="p">().</span><span class="n">createHWComposer</span><span class="p">(</span><span class="n">getBE</span><span class="p">().</span><span class="n">mHwcServiceName</span><span class="p">))</span><span class="err">①</span>
    <span class="p">....</span>
<span class="p">}</span>

<span class="n">SurfaceFlingerBE</span><span class="o">::</span><span class="n">SurfaceFlingerBE</span><span class="p">()</span> <span class="o">:</span> <span class="n">mHwcServiceName</span><span class="p">(</span><span class="n">getServiceName</span><span class="p">()){}</span>

<span class="n">srd</span><span class="o">::</span><span class="n">String</span> <span class="nf">getHwcServiceName</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="n">PROPERTY_VALUE_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="n">property_get</span><span class="p">(</span><span class="s">"debug.sf.hwc_service_name"</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="s">"default"</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1">// frameworks/native/services/surfaceflinger/SurfaceFlinger.h</span>
    <span class="n">SurfaceFlingerBE</span><span class="o">&amp;</span> <span class="n">getBE</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">mBE</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">const</span> <span class="n">SurfaceFlingerBE</span><span class="o">&amp;</span> <span class="n">getBE</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">mBE</span><span class="p">;</span> <span class="p">}</span>
    <span class="n">SurfaceFlingerBE</span> <span class="n">mBE</span><span class="p">;</span>

</pre></table></code></div></div><ol><li>HWComposer 与 SurfaceFlinger 的联系</ol><p>SF 通过层层封装，将 Composer 封装在功能模块</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="res/picture/hwcomposer.jpg" alt="" /></p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
</pre><td class="rouge-code"><pre><span class="c1">// frameworks/native/services/surfaceflinger/SurfaceFlingerFactory.cpp</span>
<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">HWComposer</span><span class="o">&gt;</span> <span class="n">createHWComposer</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">serviceName</span><span class="p">)</span>  <span class="k">override</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">strd</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">android</span><span class="o">::</span><span class="n">impl</span><span class="o">::</span><span class="n">HWComposer</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">Hwc2</span><span class="o">::</span><span class="n">impl</span><span class="o">::</span><span class="n">Composer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">serviceName</span><span class="p">)</span>
    <span class="p">);</span>
<span class="p">}</span>

<span class="c1">// frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.h</span>
<span class="k">namespace</span> <span class="n">android</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="k">class</span> <span class="nc">HWComposer</span> <span class="p">{</span>
    <span class="p">....</span><span class="c1">//很多纯虚功能函数</span>
<span class="p">}</span>
<span class="k">namespace</span> <span class="n">impl</span> <span class="p">{</span>
    <span class="k">class</span> <span class="nc">HWComposer</span> <span class="k">final</span><span class="o">:</span><span class="k">public</span> <span class="n">android</span><span class="o">::</span><span class="n">HWComposer</span> <span class="p">{</span>
        <span class="nl">public:</span>
            <span class="k">explicit</span> <span class="n">HWComposer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Hwc2</span><span class="o">::</span><span class="n">Composer</span><span class="o">&gt;</span> <span class="n">composer</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
<span class="c1">// frameworks/native/services/surfaceflinger/DisplayHardware/ComposerHal.h</span>
<span class="k">namespace</span> <span class="n">android</span> <span class="p">{</span>
    <span class="k">namespace</span> <span class="n">Hwc2</span> <span class="p">{</span>
        <span class="p">....</span>
        <span class="k">class</span> <span class="nc">Composer</span> <span class="p">{</span>
            <span class="c1">//很多纯虚功能函数</span>
        <span class="p">}</span> 
        <span class="k">namespace</span> <span class="n">impl</span> <span class="p">{</span>
            <span class="k">class</span> <span class="nc">CommandReader</span><span class="o">:</span><span class="k">public</span> <span class="n">CommandReaderBase</span> <span class="p">{</span>

            <span class="p">}</span>
            <span class="k">class</span> <span class="nc">Composer</span> <span class="k">final</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Hwc2</span><span class="o">::</span><span class="n">Composer</span> <span class="p">{</span>
                <span class="p">....</span>
                <span class="n">sp</span><span class="o">&lt;</span><span class="n">V2_1</span><span class="o">::</span><span class="n">IComposer</span><span class="o">&gt;</span> <span class="n">mComposer</span><span class="p">;</span>
                <span class="n">sp</span><span class="o">&lt;</span><span class="n">V2_1</span><span class="o">::</span><span class="n">IComposerClient</span><span class="o">&gt;</span> <span class="n">mClient</span><span class="p">;</span>
                <span class="n">sp</span><span class="o">&lt;</span><span class="n">V2_2</span><span class="o">::</span><span class="n">IComposerClient</span><span class="o">&gt;</span> <span class="n">mClient_2_2</span><span class="p">;</span>
                <span class="n">sp</span><span class="o">&lt;</span><span class="n">IComposerClient</span><span class="o">&gt;</span> <span class="n">mClient_2_3</span><span class="p">;</span>
                <span class="n">CommandWriter</span> <span class="n">mWriter</span><span class="p">;</span>
                <span class="n">CommandReader</span> <span class="n">mReader</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//frameworks/native/services/surfaceflinger/DisplayHardware/ComposerHal.cpp</span>
<span class="k">namespace</span> <span class="n">android</span> <span class="p">{</span>
    <span class="k">namespace</span> <span class="n">Hwc2</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="k">namespace</span> <span class="n">impl</span> <span class="p">{</span>
            <span class="n">Composer</span><span class="o">::</span><span class="n">Composer</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">servicename</span><span class="p">)</span><span class="o">:</span><span class="n">mWrite</span><span class="p">(</span><span class="n">kWriterInitialSize</span><span class="p">),</span> <span class="n">mIsUsingVrComposer</span><span class="p">(</span><span class="n">serviceName</span> <span class="o">==</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="s">"vr"</span><span class="p">)){</span>
                <span class="c1">//通过HIDL通信获取 HAL service。</span>
                <span class="n">mComposer</span> <span class="o">=</span> <span class="n">V2_1</span><span class="o">::</span><span class="n">IComposer</span><span class="o">::</span><span class="n">getService</span><span class="p">(</span><span class="n">serviceName</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sp</span><span class="o">&lt;</span><span class="n">IComposer</span><span class="o">&gt;</span> <span class="n">composer_2_3</span> <span class="o">=</span> <span class="n">IComposer</span><span class="o">::</span><span class="n">castFrom</span><span class="p">(</span><span class="n">mComposer</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">composer_2_3</span><span class="o">-&gt;</span><span class="n">createClient_2_3</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">cost</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">tmpError</span><span class="p">,</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">tmpClient</span><span class="p">){</span>
                        <span class="p">....</span>
                        <span class="n">mClient</span> <span class="o">=</span> <span class="n">tmpClient</span><span class="p">;</span>
                        <span class="n">mClient_2_2</span> <span class="o">=</span> <span class="n">tmpClient</span><span class="p">;</span>
                        <span class="n">mClient_3_3</span> <span class="o">=</span> <span class="n">tmpClient</span><span class="p">;</span>
                    <span class="p">});</span>
                <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                    <span class="n">mComposer</span><span class="o">-&gt;</span><span class="n">createClient_2_3</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="n">cost</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">tmpError</span><span class="p">,</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">tmpClient</span><span class="p">){</span>
                        <span class="p">...</span>
                        <span class="n">mClient</span> <span class="o">=</span> <span class="n">tmpClient</span><span class="p">;</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// framework/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp</span>
<span class="k">namespace</span> <span class="n">android</span> <span class="p">{</span>

    <span class="k">namespace</span> <span class="n">impl</span> <span class="p">{</span>
        <span class="n">HWComposer</span><span class="o">::</span><span class="n">HWComposer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Hwc2</span><span class="o">::</span><span class="n">Composer</span><span class="o">&gt;</span> <span class="n">composer</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">mHwcDevice</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">HWC2</span><span class="o">::</span><span class="n">Device</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">composer</span><span class="p">))){}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// framework/native/services/surfaceflinger/DisplayHardware/HWC2.h</span>
<span class="k">namespace</span> <span class="n">HWC2</span> <span class="p">{</span>
    <span class="k">class</span> <span class="nc">Display</span><span class="p">;</span>
    <span class="k">class</span> <span class="nc">Display</span><span class="p">{</span>
        <span class="c1">//很多display相关的纯虚函数</span>
    <span class="p">}</span>
    <span class="k">class</span> <span class="nc">Layer</span><span class="p">;</span>
        <span class="k">class</span> <span class="nc">Layer</span><span class="p">{</span>
        <span class="c1">//很多Layer相关的纯虚函数</span>
    <span class="p">}</span>
    <span class="k">class</span> <span class="nc">ComposerCallback</span><span class="p">{}</span>
    <span class="k">class</span> <span class="nc">Device</span><span class="p">{</span>
        <span class="p">...</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">android</span><span class="o">::</span><span class="n">Hwc2</span><span class="o">::</span><span class="n">Composer</span><span class="o">&gt;</span> <span class="n">mComposer</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">namespace</span> <span class="n">impl</span><span class="p">{</span>
        <span class="k">class</span> <span class="nc">Display</span><span class="o">:</span><span class="k">public</span> <span class="n">HWC2</span><span class="o">::</span><span class="n">Display</span><span class="p">{</span>
            <span class="c1">//很多Display相关的虚函数</span>
            <span class="p">...</span>
            <span class="n">android</span><span class="o">::</span><span class="n">Hwc2</span><span class="o">::</span><span class="n">Composer</span><span class="o">&amp;</span> <span class="n">mComposer</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">class</span> <span class="nc">Layer</span><span class="o">:</span><span class="k">public</span> <span class="n">HWC2</span><span class="o">::</span><span class="n">Layer</span><span class="p">{</span>
            <span class="c1">//很多Layer相关的虚函数</span>
            <span class="p">...</span>
            <span class="n">android</span><span class="o">::</span><span class="n">Hwc2</span><span class="o">::</span><span class="n">Composer</span><span class="o">&amp;</span> <span class="n">mComposer</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// framework/native/services/surfaceflinger/DisplayHardware/HWC2.cpp</span>
<span class="k">namespace</span> <span class="n">HWC2</span> <span class="p">{</span>
    <span class="n">Device</span><span class="o">::</span><span class="n">Device</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">android</span><span class="o">::</span><span class="n">Hwc2</span><span class="o">::</span><span class="n">Composer</span><span class="o">&gt;</span> <span class="n">composer</span><span class="p">)</span><span class="o">:</span><span class="n">mComposer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">composer</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">loadCapabilities</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="探究composer库">探究Composer库</h2><p>在surfaceflinger的mk文件中我们搜索的composer的库为</p><ul><li>android.hardware.graphics.composer@2.1<li>android.hardware.graphics.composer@2.2<li>android.hardware.graphics.composer@2.3</ul><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c">&lt;!--frameworks/native/services/surfaceflinger/Android.bp--&gt;</span>
cc_defaults {
    name: "libsurfaceflinger_defaults",
    defaults:["surfaceflinger_defaults"],
    shared_libs: [
        "android.frameworks.vr.composer@1.0",
        "android.hardware.graphics.composer@2.1",
        "android.hardware.graphics.composer@2.2",
        "android.hardware.graphics.composer@2.3",
    ]
}

</pre></table></code></div></div><p>通过搜索代码可以发现android.hardware.graphics.composer@2.1这个库在”hardware/interfaces/graphics/composer/2.1”,2.2和2.3与2.1只是版本迭代原理相同。</p><blockquote><p>由于这个compsoer@2.1 是一个HIDL接口库,其实现都放在了default文件夹，在这个文件夹下我们可以看到有关键的四分文件</p></blockquote><ul><li>default<ul><li>Android.bp<li>android.hardware.graphics.composer@2.1-service.rc<li>passthrough.cpp<li>service.cpp</ul></ul><p>Android.bp 文件会编译2个包，一个是以passthrough.cpp为资源文件的动态库，另一个是以service.cpp为资源的可执行库，而上面的rc文件就是启动这个执行库的入口。</p><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>cc_library_shared {
    name: "android.hardware.graphics.composer@2.1-impl",
    srcs:["passthrough.cpp"],
    ...
}

cc_binary {
    name: "android.hardware.graphics.composer@2.1-service",
    srcs: ["service.cpp"],
    ...
}
</pre></table></code></div></div><p>首先看一下service.cpp文件</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">// hardware/interfaces/graphics/composer/2.1/default/service.cpp</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">android</span><span class="o">::</span><span class="n">ProcessState</span><span class="o">::</span><span class="n">initWithDriver</span><span class="p">(</span><span class="s">"dev/vndbinder"</span><span class="p">);</span>
    <span class="n">android</span><span class="o">::</span><span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">setThreadPoolMaxThreadCount</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="n">android</span><span class="o">::</span><span class="n">ProcessState</span><span class="o">::</span><span class="n">self</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">startThreadPool</span><span class="p">();</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="n">defaultPassthroughServiceImplementation</span><span class="o">&lt;</span><span class="n">IComposer</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// hardware/interfaces/graphics/composer/2.1/default/passthrough.cpp</span>
<span class="k">using</span> <span class="n">android</span><span class="o">::</span><span class="n">hardware</span><span class="o">::</span><span class="n">graphics</span><span class="o">::</span><span class="n">composer</span><span class="o">::</span><span class="n">V2_1</span><span class="o">::</span><span class="n">passthrough</span><span class="o">::</span><span class="n">HwcLoader</span><span class="p">;</span>
<span class="k">extern</span> <span class="s">"C"</span> <span class="n">IComposer</span><span class="o">*</span> <span class="nf">HIDL_FETCH_IComposer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="cm">/*name*/</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">HwcLoader</span><span class="o">::</span><span class="n">load</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Android的HIDL原理这里就不介绍了，”defaultPassthroughServiceImplementation“方法最终会去调用直通模式的入库函数HIDL_FETCH_IComposer，而该入口只干一件事”load()”。 接下来就让我们看看这个HwcLoader::load()。</p><h2 id="hwcloader">HwcLoader</h2><p>HwcLoader 顾名思义是用来加载Hwc的，至于加载的是谁，通过阅读代码可知是加载时composer驱动，这里存在Android加载硬件驱动程序的固有套路就不详细介绍了。 这里load主要分为三个部分：</p><ol><li>loadModule:加载驱动模块<li>createHalWithAdapter:创建ComposerHal实例<li>createComposer:构建Composer实例</ol><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">namespace</span> <span class="n">hardware</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">graphics</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">composer</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">V2_1</span> <span class="p">{</span>
<span class="k">namespace</span> <span class="n">passthrough</span> <span class="p">{</span>

<span class="k">class</span> <span class="nc">HwcLoader</span> <span class="p">{</span>
   <span class="nl">public:</span>
    <span class="k">static</span> <span class="n">IComposer</span><span class="o">*</span> <span class="n">load</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">hw_module_t</span><span class="o">*</span> <span class="n">module</span> <span class="o">=</span> <span class="n">loadModule</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">module</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">auto</span> <span class="n">hal</span> <span class="o">=</span> <span class="n">createHalWithAdapter</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hal</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">createComposer</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">hal</span><span class="p">));</span>
    <span class="p">}</span>
</pre></table></code></div></div><h3 id="composer-驱动模块的加载">Composer 驱动模块的加载</h3><p>通过hw_get_module接口根据HWC_HARDWARE_MODULE_ID也就是“hwcomposer”去找到相应的库，首先会去根据property属性去查找，然后再根据一些配置信息去查找，最后再使用“hwcomposer.default.so”，通过查找代码可以找的该默认库的编译脚本的路径为：hardware\libhardware\modules\hwcomposer\Android.bp,而当前我的Android 10的模拟器使用的是“vendor/lib/hw/hwcomposer.ranchu.so”,而默认库与非默认库存在的区别在于默认库没有什么扩展功能，这一点在接下来的“hwc2_device_t”结构体就能够看出来。</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre><td class="rouge-code"><pre>    <span class="c1">// load hwcomposer2 module</span>
    <span class="k">static</span> <span class="k">const</span> <span class="n">hw_module_t</span><span class="o">*</span> <span class="nf">loadModule</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">hw_module_t</span><span class="o">*</span> <span class="n">module</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">hw_get_module</span><span class="p">(</span><span class="n">HWC_HARDWARE_MODULE_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ALOGI</span><span class="p">(</span><span class="s">"falling back to gralloc module"</span><span class="p">);</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">hw_get_module</span><span class="p">(</span><span class="n">GRALLOC_HARDWARE_MODULE_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">module</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ALOGE</span><span class="p">(</span><span class="s">"failed to get hwcomposer or gralloc module"</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">module</span><span class="p">;</span>
    <span class="p">}</span>
<span class="c1">// hardware\libhardware\include\hardware\hwcomposer_defs.h</span>
<span class="cp">#define HWC_HARDWARE_MODULE_ID "hwcomposer"
</span><span class="c1">// hardware\libhardware\include\hardware\hwcomposer.h</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">hwc_composer_device_1</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="nc">hw_device_t</span> <span class="n">common</span><span class="p">;</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">prepare</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">hwc_composer_device_1</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
                    <span class="kt">size_t</span> <span class="n">numDisplays</span><span class="p">,</span> <span class="n">hwc_display_contents_1_t</span><span class="o">**</span> <span class="n">displays</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">hwc_composer_device_1</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
                <span class="kt">size_t</span> <span class="n">numDisplays</span><span class="p">,</span> <span class="n">hwc_display_contents_1_t</span><span class="o">**</span> <span class="n">displays</span><span class="p">);</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">eventControl</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">hwc_composer_device_1</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disp</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">event</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enabled</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">getDisplayConfigs</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">hwc_composer_device_1</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">disp</span><span class="p">,</span>
            <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">configs</span><span class="p">,</span> <span class="kt">size_t</span><span class="o">*</span> <span class="n">numConfigs</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="n">hwc_composer_device_1_t</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">hwc_module</span> <span class="p">{</span>
    <span class="cm">/**
     * Common methods of the hardware composer module.  This *must* be the first member of
     * hwc_module as users of this structure will cast a hw_module_t to
     * hwc_module pointer in contexts where it's known the hw_module_t references a
     * hwc_module.
     */</span>
    <span class="k">struct</span> <span class="nc">hw_module_t</span> <span class="n">common</span><span class="p">;</span>
<span class="p">}</span> <span class="n">hwc_module_t</span><span class="p">;</span>

<span class="c1">// hardware\libhardware\modules\hwcomposer\hwcomposer.cpp</span>
<span class="n">hwc_module_t</span> <span class="n">HAL_MODULE_INFO_SYM</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">common</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">HARDWARE_MODULE_TAG</span><span class="p">,</span>
        <span class="p">.</span><span class="n">version_major</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">version_minor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">HWC_HARDWARE_MODULE_ID</span><span class="p">,</span>
        <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">"Sample hwcomposer module"</span><span class="p">,</span>
        <span class="p">.</span><span class="n">author</span> <span class="o">=</span> <span class="s">"The Android Open Source Project"</span><span class="p">,</span>
        <span class="p">.</span><span class="n">methods</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hwc_module_methods</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="nc">hwc_context_t</span> <span class="p">{</span>
    <span class="n">hwc_composer_device_1_t</span> <span class="n">device</span><span class="p">;</span>
    <span class="cm">/* our private state goes below here */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hwc_device_open</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="nc">hw_module_t</span><span class="o">*</span> <span class="n">module</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">hw_device_t</span><span class="o">**</span> <span class="n">device</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="nc">hw_module_methods_t</span> <span class="n">hwc_module_methods</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">hwc_device_open</span><span class="c1">//@_1</span>
<span class="p">};</span>
</pre></table></code></div></div><p>至此上述说的第一步“loadModule:加载驱动模块” 就完成了，接下来就会根据第一步获取的 hw_module_t 来进行第二步。</p><h3 id="创建composerhal实例">创建ComposerHal实例</h3><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre>    <span class="c1">// create a ComposerHal instance, insert an adapter if necessary</span>
    <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">ComposerHal</span><span class="o">&gt;</span> <span class="n">createHalWithAdapter</span><span class="p">(</span><span class="k">const</span> <span class="n">hw_module_t</span><span class="o">*</span> <span class="n">module</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">bool</span> <span class="n">adapted</span><span class="p">;</span>
        <span class="n">hwc2_device_t</span><span class="o">*</span> <span class="n">device</span> <span class="o">=</span> <span class="n">openDeviceWithAdapter</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapted</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">auto</span> <span class="n">hal</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">HwcHal</span><span class="o">&gt;</span><span class="p">();</span>
        <span class="k">return</span> <span class="n">hal</span><span class="o">-&gt;</span><span class="n">initWithDevice</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="o">!</span><span class="n">adapted</span><span class="p">)</span> <span class="o">?</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">hal</span><span class="p">)</span> <span class="o">:</span> <span class="nb">nullptr</span><span class="p">;</span><span class="c1">//@_2</span>
    <span class="p">}</span>

    <span class="c1">// open hwcomposer2 device, install an adapter if necessary</span>
    <span class="k">static</span> <span class="n">hwc2_device_t</span><span class="o">*</span> <span class="nf">openDeviceWithAdapter</span><span class="p">(</span><span class="k">const</span> <span class="n">hw_module_t</span><span class="o">*</span> <span class="n">module</span><span class="p">,</span> <span class="kt">bool</span><span class="o">*</span> <span class="n">outAdapted</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">module</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">GRALLOC_HARDWARE_MODULE_ID</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">outAdapted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">adaptGrallocModule</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">hw_device_t</span><span class="o">*</span> <span class="n">device</span><span class="p">;</span>
        <span class="c1">//这里的open就是前面@_1处的hwc_device_open</span>
        <span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">module</span><span class="o">-&gt;</span><span class="n">methods</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">HWC_HARDWARE_COMPOSER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ALOGE</span><span class="p">(</span><span class="s">"failed to open hwcomposer device: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="o">-</span><span class="n">error</span><span class="p">));</span>
            <span class="k">return</span> <span class="nb">nullptr</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="kt">int</span> <span class="n">major</span> <span class="o">=</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">major</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">outAdapted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">adaptHwc1Device</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">hwc_composer_device_1</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">device</span><span class="p">)));</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">outAdapted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">hwc2_device_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>上面提到的open其实就是@_1处的hwc_device_open,而这个函数里其实就是给我们hw_device_t结构体赋值，包括指定其close函数指定为“hwc_device_close”，openDeviceWithAdapter将hw_device_t强转为hwc2_device，是因为hwc2_device的首地址就是指向其首成员hw_device_t common；</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">hwc2_device</span> <span class="p">{</span>
    <span class="cm">/* Must be the first member of this struct, since a pointer to this struct
     * will be generated by casting from a hw_device_t* */</span>
    <span class="k">struct</span> <span class="nc">hw_device_t</span> <span class="n">common</span><span class="p">;</span>

    <span class="cm">/* getCapabilities(..., outCount, outCapabilities)
     *
     * Provides a list of capabilities (described in the definition of
     * hwc2_capability_t above) supported by this device. This list must
     * not change after the device has been loaded.
     */</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">getCapabilities</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">hwc2_device</span><span class="o">*</span> <span class="n">device</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="o">*</span> <span class="n">outCount</span><span class="p">,</span>
            <span class="kt">int32_t</span><span class="o">*</span> <span class="cm">/*hwc2_capability_t*/</span> <span class="n">outCapabilities</span><span class="p">);</span>

    <span class="cm">/* getFunction(..., descriptor)
     *
     * Returns a function pointer which implements the requested description.
     *
     * Parameters:
     *   descriptor - the function to return
     *
     * Returns either a function pointer implementing the requested descriptor
     *   or NULL if the described function is not supported by this device.
     */</span>
    <span class="n">hwc2_function_pointer_t</span> <span class="p">(</span><span class="o">*</span><span class="n">getFunction</span><span class="p">)(</span><span class="k">struct</span> <span class="nc">hwc2_device</span><span class="o">*</span> <span class="n">device</span><span class="p">,</span>
            <span class="kt">int32_t</span> <span class="cm">/*hwc2_function_descriptor_t*/</span> <span class="n">descriptor</span><span class="p">);</span>
<span class="p">}</span> <span class="n">hwc2_device_t</span><span class="p">;</span>
</pre></table></code></div></div><p>有了hwc2_device_t后我们再看一下@_2处，该环节是通过hwc2_device_t里的getCapabilities跟getFunction初始化hwcomposer库里的功能函数。这里说明一下如果是默认库，也即”hwcomposer.default.so”,由于没有给getCapabilities跟getFunction赋值所以这里就是空执行。同期可以参考一下高通的hwcomposer库。</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="c1">// hardware\qcom\display\msm8909\sdm\libs\hwc2\hwcomposer.cpp</span>
<span class="n">hwc2_device_t</span> <span class="n">dummy_device</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">common</span> <span class="o">=</span> <span class="p">{.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">HARDWARE_DEVICE_TAG</span><span class="p">,</span>
               <span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">HWC_DEVICE_API_VERSION_2_0</span><span class="p">,</span>
               <span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">HAL_MODULE_INFO_SYM</span><span class="p">,</span>
               <span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">Hwc2DeviceClose</span><span class="p">},</span>
    <span class="p">.</span><span class="n">getCapabilities</span> <span class="o">=</span> <span class="n">Hwc2GetCapabilities</span><span class="p">,</span>
    <span class="p">.</span><span class="n">getFunction</span> <span class="o">=</span> <span class="n">Hwc2GetFunction</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">Hwc2DeviceOpen</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="nc">hw_module_t</span><span class="o">*</span> <span class="cm">/*module*/</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
                   <span class="k">struct</span> <span class="nc">hw_device_t</span><span class="o">**</span> <span class="n">device</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">HWC_HARDWARE_COMPOSER</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">physical_display</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">hwc2_display_t</span> <span class="n">physical_dummy</span><span class="p">;</span>

    <span class="n">Hwc2ImplCreateVirtualDisplay</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_device</span><span class="p">,</span> <span class="n">kPhysicalDummyWidth</span><span class="p">,</span>
                                 <span class="n">kPhysicalDummyHeight</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span>
                                 <span class="o">&amp;</span><span class="n">physical_dummy</span><span class="p">);</span>

    <span class="n">displays</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">physical_dummy</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">MakePhysical</span><span class="p">();</span>

    <span class="n">Hwc2ImplSetActiveConfig</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dummy_device</span><span class="p">,</span> <span class="n">physical_dummy</span><span class="p">,</span> <span class="n">kDummyConfig</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dummy_device</span><span class="p">.</span><span class="n">common</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>接下来就让我们看看这个设备功能初始化——initWithDevice</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c1">// hardware\interfaces\graphics\composer\2.1\utils\passthrough\include\composer-passthrough\2.1\HwcHal.h</span>

<span class="k">using</span> <span class="n">HwcHal</span> <span class="o">=</span> <span class="n">detail</span><span class="o">::</span><span class="n">HwcHalImpl</span><span class="o">&lt;</span><span class="n">hal</span><span class="o">::</span><span class="n">ComposerHal</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">Hal</span><span class="p">&gt;</span>
<span class="k">class</span> <span class="nc">HwcHalImpl</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Hal</span> <span class="p">{</span>
<span class="p">...</span>
    <span class="kt">bool</span> <span class="n">initWithDevice</span><span class="p">(</span><span class="n">hwc2_device_t</span><span class="o">*</span> <span class="n">device</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">requireReliablePresentFence</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// we own the device from this point on</span>
        <span class="n">mDevice</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
        <span class="n">initCapabilities</span><span class="p">();</span><span class="c1">//该函数较为简单就是获取驱动设备的功能个数。</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">requireReliablePresentFence</span> <span class="o">&amp;&amp;</span>
            <span class="n">hasCapability</span><span class="p">(</span><span class="n">HWC2_CAPABILITY_PRESENT_FENCE_IS_NOT_RELIABLE</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">ALOGE</span><span class="p">(</span><span class="s">"present fence must be reliable"</span><span class="p">);</span>
            <span class="n">mDevice</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mDevice</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">);</span>
            <span class="n">mDevice</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initDispatch</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">mDevice</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mDevice</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">);</span>
            <span class="n">mDevice</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>其中initCapabilities较为简单就是获取驱动设备的功能个数，而initDispatch则是将本地的功能函数与驱动设备的做映射。</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="cm">/* Function descriptors for use with getFunction */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">HWC2_FUNCTION_INVALID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">HWC2_FUNCTION_ACCEPT_DISPLAY_CHANGES</span><span class="p">,</span>
    <span class="n">HWC2_FUNCTION_CREATE_LAYER</span><span class="p">,</span>
    <span class="n">HWC2_FUNCTION_CREATE_VIRTUAL_DISPLAY</span><span class="p">,</span>
    <span class="n">HWC2_FUNCTION_DESTROY_LAYER</span><span class="p">,</span>
    <span class="n">HWC2_FUNCTION_DESTROY_VIRTUAL_DISPLAY</span><span class="p">,</span>
    <span class="n">HWC2_FUNCTION_DUMP</span><span class="p">,</span>
    <span class="p">...</span><span class="c1">//太多就省略</span>
    <span class="n">HWC2_FUNCTION_SET_DISPLAY_BRIGHTNESS</span><span class="p">,</span>
<span class="p">}</span> <span class="n">hwc2_function_descriptor_t</span><span class="p">;</span>

    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
    <span class="kt">bool</span> <span class="nf">initDispatch</span><span class="p">(</span><span class="n">hwc2_function_descriptor_t</span> <span class="n">desc</span><span class="p">,</span> <span class="n">T</span><span class="o">*</span> <span class="n">outPfn</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="n">pfn</span> <span class="o">=</span> <span class="n">mDevice</span><span class="o">-&gt;</span><span class="n">getFunction</span><span class="p">(</span><span class="n">mDevice</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pfn</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">*</span><span class="n">outPfn</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">pfn</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">ALOGE</span><span class="p">(</span><span class="s">"failed to get hwcomposer2 function %d"</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">virtual</span> <span class="kt">bool</span> <span class="nf">initDispatch</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">initDispatch</span><span class="p">(</span><span class="n">HWC2_FUNCTION_ACCEPT_DISPLAY_CHANGES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mDispatch</span><span class="p">.</span><span class="n">acceptDisplayChanges</span><span class="p">)</span> <span class="o">||</span>
            <span class="o">!</span><span class="n">initDispatch</span><span class="p">(</span><span class="n">HWC2_FUNCTION_CREATE_LAYER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mDispatch</span><span class="p">.</span><span class="n">createLayer</span><span class="p">)</span> <span class="o">||</span>
            <span class="o">!</span><span class="n">initDispatch</span><span class="p">(</span><span class="n">HWC2_FUNCTION_CREATE_VIRTUAL_DISPLAY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mDispatch</span><span class="p">.</span><span class="n">createVirtualDisplay</span><span class="p">)</span> <span class="o">||</span>
            <span class="o">!</span><span class="n">initDispatch</span><span class="p">(</span><span class="n">HWC2_FUNCTION_DESTROY_LAYER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mDispatch</span><span class="p">.</span><span class="n">destroyLayer</span><span class="p">)</span> <span class="o">||</span>
            <span class="p">.....</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>mDispatch 是一个宏定义结构体，通过getFunction会从设备那边返回一个函数指针给到mDispatch里对应的成员，这样一来就可以通过HAL接口的mDispatch里的函数去访问硬件厂商的hwcomposer库里的函数了。</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">typedef</span> <span class="kt">int32_t</span> <span class="cm">/*hwc2_error_t*/</span> <span class="p">(</span><span class="o">*</span><span class="n">HWC2_PFN_ACCEPT_DISPLAY_CHANGES</span><span class="p">)(</span>
        <span class="n">hwc2_device_t</span><span class="o">*</span> <span class="n">device</span><span class="p">,</span> <span class="n">hwc2_display_t</span> <span class="n">display</span><span class="p">);</span>
 <span class="k">struct</span> <span class="p">{</span>
        <span class="n">HWC2_PFN_ACCEPT_DISPLAY_CHANGES</span> <span class="n">acceptDisplayChanges</span><span class="p">;</span>
        <span class="n">HWC2_PFN_CREATE_LAYER</span> <span class="n">createLayer</span><span class="p">;</span>
        <span class="n">HWC2_PFN_CREATE_VIRTUAL_DISPLAY</span> <span class="n">createVirtualDisplay</span><span class="p">;</span>
        <span class="n">HWC2_PFN_DESTROY_LAYER</span> <span class="n">destroyLayer</span><span class="p">;</span>
        <span class="n">HWC2_PFN_DESTROY_VIRTUAL_DISPLAY</span> <span class="n">destroyVirtualDisplay</span><span class="p">;</span>
        <span class="n">HWC2_PFN_DUMP</span> <span class="n">dump</span><span class="p">;</span>
        <span class="p">....</span>
 <span class="p">}</span> <span class="n">mDispatch</span><span class="o">=</span><span class="p">{}</span>
</pre></table></code></div></div><p>hardware\qcom\display\msm8909\sdm\libs\hwc2\hwcomposer.cpp</p><div class="language-cpp highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kt">int32_t</span> <span class="nf">Hwc2ImplAcceptDisplayChanges</span><span class="p">(</span><span class="n">hwc2_device_t</span><span class="o">*</span> <span class="cm">/*device*/</span><span class="p">,</span>
                                     <span class="n">hwc2_display_t</span> <span class="n">display</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">displays</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">display</span><span class="p">)</span> <span class="o">==</span> <span class="n">displays</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">HWC2_ERROR_BAD_DISPLAY</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">HWC2_ERROR_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">hwc2_function_pointer_t</span> <span class="nf">Hwc2GetFunction</span><span class="p">(</span><span class="k">struct</span> <span class="nc">hwc2_device</span><span class="o">*</span> <span class="cm">/*device*/</span><span class="p">,</span>
                                        <span class="kt">int32_t</span> <span class="n">descriptor</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">descriptor</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">HWC2_FUNCTION_ACCEPT_DISPLAY_CHANGES</span><span class="p">:</span>
      <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">hwc2_function_pointer_t</span><span class="o">&gt;</span><span class="p">(</span>
          <span class="n">Hwc2ImplAcceptDisplayChanges</span><span class="p">);</span>
    <span class="k">case</span> <span class="n">HWC2_FUNCTION_CREATE_LAYER</span><span class="p">:</span>
      <span class="k">return</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">hwc2_function_pointer_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Hwc2ImplCreateLayer</span><span class="p">);</span>
      <span class="p">...</span>
  <span class="p">}</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android/'>Android</a>, <a href='/categories/framework/'>Framework</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/framework/" class="post-tag no-text-decoration" >Framework</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=SurfaceFlinger 之 HWComposer - SunMoon&url=https://dongxiaofat.github.io/posts/SurfaceFlinger-HWComposer/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=SurfaceFlinger 之 HWComposer - SunMoon&u=https://dongxiaofat.github.io/posts/SurfaceFlinger-HWComposer/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=SurfaceFlinger 之 HWComposer - SunMoon&url=https://dongxiaofat.github.io/posts/SurfaceFlinger-HWComposer/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/text-and-typography/">Text and Typography</a><li><a href="/posts/customize-the-favicon/">Customize the Favicon</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/framework/">Framework</a> <a class="post-tag" href="/tags/favicon/">favicon</a> <a class="post-tag" href="/tags/typography/">typography</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/AndroidFont/"><div class="card-body"> <span class="timeago small" > Feb 16 <i class="unloaded">2021-02-16T16:30:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>深入理解Android Font 机制</h3><div class="text-muted small"><p> 深入理解Android Font 机制 Android 字体是由配置好的ttf字体文件来描述的，然而在字体加载的过程中首先就是根据字符去匹配相应的ttf文件，然后在该ttf文件中依照Unicode编码查找字符形状进行描绘。 Unicode编码 Unicode 规范规定，使用U+前缀加上一个十六进制的整数表示一个字符，比如U+0041表示大写拉丁字母A。而整个Unicode的字符集...</p></div></div></a></div><div class="card"> <a href="/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Zygote-%E5%90%AF%E5%8A%A8/"><div class="card-body"> <span class="timeago small" > Feb 25 <i class="unloaded">2021-02-25T20:45:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>深入理解 AndroidFramework 之 Zygote 启动</h3><div class="text-muted small"><p> 深入理解 AndroidFramework 之 Zygote 启动 Zygote 作为Android 第一个出道的进程被广大网友所熟知，那么该进程是如何被加载，如何运行的呢？在这里我们就尝试将她神秘的面纱一层层揭开。 1. Init 进程 Linux中PID为0的进程是所有其他进程的祖先, 也称作idle进程或swapper进程，在系统初始化时由kernel自身从无到有创...</p></div></div></a></div><div class="card"> <a href="/posts/Android-oom-adj/"><div class="card-body"> <span class="timeago small" > Feb 26 <i class="unloaded">2021-02-26T08:45:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android OOM Low Memory Killer 机制</h3><div class="text-muted small"><p> Android OOM Low Memory Killer 机制 本文主要介绍Android的low memory killer的 oom_adj的相关概念，以及根据一些案例来阐述了解oom_adj对于做Android应用开发的重要意义。 1. Low Memory Killer中进程的分类以及各类进程的adj值 在Android的low memroy killer机制中，会对于所...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Android-oom-adj/" class="btn btn-outline-primary" prompt="Older"><p>Android OOM Low Memory Killer 机制</p></a> <a href="/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3SystemServer%E5%90%AF%E5%8A%A8/" class="btn btn-outline-primary" prompt="Newer"><p>深入理解SystemServer启动</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://gitee.com/DongXiaoFat">DongChunYang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/framework/">Framework</a> <a class="post-tag" href="/tags/favicon/">favicon</a> <a class="post-tag" href="/tags/typography/">typography</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://dongxiaofat.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
