<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="深入理解 AndroidFramework 之 Zygote 启动" /><meta name="author" content="Cotes Chung" /><meta property="og:locale" content="en_US" /><meta name="description" content="介绍 Zygote 的启动流程." /><meta property="og:description" content="介绍 Zygote 的启动流程." /><link rel="canonical" href="https://dongxiaofat.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Zygote-%E5%90%AF%E5%8A%A8/" /><meta property="og:url" content="https://dongxiaofat.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Zygote-%E5%90%AF%E5%8A%A8/" /><meta property="og:site_name" content="SunMoon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-25T20:45:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="深入理解 AndroidFramework 之 Zygote 启动" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"深入理解 AndroidFramework 之 Zygote 启动","dateModified":"2021-02-25T20:45:00+08:00","description":"介绍 Zygote 的启动流程.","datePublished":"2021-02-25T20:45:00+08:00","url":"https://dongxiaofat.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Zygote-%E5%90%AF%E5%8A%A8/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://dongxiaofat.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Zygote-%E5%90%AF%E5%8A%A8/"},"author":{"@type":"Person","name":"Cotes Chung"},"@context":"https://schema.org"}</script><title>深入理解 AndroidFramework 之 Zygote 启动 | SunMoon</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/av.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">SunMoon</a></div><div class="site-subtitle font-italic">祖国尚未统一，无心写博客</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-Circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/DongXiaoFat" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github "></i> </a> <a href="https://gitee.com/DongXiaoFat" aria-label="gitee" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-git"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['chuyangdong123','outlook.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>深入理解 AndroidFramework 之 Zygote 启动</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>深入理解 AndroidFramework 之 Zygote 启动</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Feb 25, 2021, 8:45 PM +0800" > Feb 25 <i class="unloaded">2021-02-25T20:45:00+08:00</i> </span> by <span class="author"> Cotes Chung </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3763 words">20 min</span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/favicons/av.jpg" class="preview-img" alt="Preview Image"><h1 id="深入理解-androidframework-之-zygote-启动">深入理解 AndroidFramework 之 Zygote 启动</h1><blockquote><p>Zygote 作为Android 第一个出道的进程被广大网友所熟知，那么该进程是如何被加载，如何运行的呢？在这里我们就尝试将她神秘的面纱一层层揭开。</p></blockquote><h2 id="1-init-进程">1. Init 进程</h2><blockquote><p>Linux中PID为0的进程是所有其他进程的祖先, 也称作idle进程或swapper进程，在系统初始化时由kernel自身从无到有创建。进程0的数据成员大部分是静态定义的。</p></blockquote><blockquote><p>在Android系统中 0号进程会孵化出2个核心进程，一个进程号为2的名为kthreadd的进程，另一个则是进程号为1名为init的进程。kthreadd进程由idle通过kernel_thread创建，并始终运行在内核空间, 负责所有内核线程的调度和管理，所有的内核线程都是直接或者间接的以kthreadd为父进程。Init 进程是负责解析并执行 rc 文件。</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/res/picture/ps.png" alt="图 1.1" /></p><h2 id="2-initrc-启动zygote-服务">2. init.rc 启动zygote 服务</h2><blockquote><p>Zygote 进程是init 进程通过解析init.zygote64.rc 启动的（如果是32位系统就会解析init.zygote32.rc），接下来我们就来捋一捋zygote的前世今生。</p></blockquote><ul><li>涉及的文件：<ol><li>system/core/rootdir/init.zygote64.rc<li>frameworks/base/cmds/app_process/Android.bp<li>frameworks/base/cmds/app_process/app_main.cpp<li>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</ol><li>init.zygote64.rc 文件内容如下： ``` //system/core/rootdir/init.zygote64.rc</ul><p>service zygote /system/bin/app_process64 -Xzygote /system/bin –zygote –start-system-server class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system \创建socket socket usap_pool_primary stream 660 root system \创建socket onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond writepid /dev/cpuset/foreground/tasks</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>
服务名称：zygote

服务路径名：/system/bin/app_process64

启动参数：  '-Xzygote'、'/system/bin'、'--zygote'、'--start-system-server'

关于 rc 脚步具体可以参照 system/core/init/README.md

## 3. Zygote 进程的入口函数 —— main

### 3.1 Zygote的可执行库文件

从 zygot 的rc文件中可以看出，它的执行路径是“/system/bin/app_process64”，执行的库文件是“app_process64”， 我们通过查找编译文件找到了该执行库文件的Android.bp或Android.mk 所在。

代码路径 frameworks/base/cmds/app_process/Android.bp

</pre></table></code></div></div><p>Aosp Q code: cc_binary { name: “app_process”,</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>srcs: ["app_main.cpp"],

multilib: {
    lib32: {
        version_script: ":art_sigchain_version_script32.txt",
        suffix: "32",//编译32位库
    },
    lib64: {
        version_script: ":art_sigchain_version_script64.txt",
        suffix: "64",//编译64位库
    },
},
</pre></table></code></div></div><p>Aosp P code:</p><p>LOCAL_MODULE:= app_process LOCAL_MULTILIB := both //32和64位库都会编译 LOCAL_MODULE_STEM_32 := app_process32 //编译32位库时命名 LOCAL_MODULE_STEM_64 := app_process64 //编译64位库时命名</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
</pre><td class="rouge-code"><pre>

### 3.2 main

main 函数的工作内容可以概括为2步：

1. 解析执行命令参数。
2. AndroidRuntime 启动进程。

在第二步中会通过jni方式执行 AndroidRuntime.cpp 中的 start 方法的第二个参数("com.android.internal.os.ZygoteInit")的main方法。

app_process64可执行库文件的 main 源代码如下：

```c++
int main(int argc, char* const argv[])
{
    ...

    AppRuntime runtime(argv[0], computeArgBlockSize(argc, argv));
    // Process command line arguments
    // ignore argv[0]
    argc--;
    argv++;

    // Everything up to '--' or first non '-' arg goes to the vm.
    //
    // The first argument after the VM args is the "parent dir", which
    // is currently unused.
    //
    // After the parent dir, we expect one or more the following internal
    // arguments :
    //
    // --zygote : Start in zygote mode
    // --start-system-server : Start the system server.
    // --application : Start in application (stand alone, non zygote) mode.
    // --nice-name : The nice name for this process.
    //
    // For non zygote starts, these arguments will be followed by
    // the main class name. All remaining arguments are passed to
    // the main method of this class.
    //
    // For zygote starts, all remaining arguments are passed to the zygote.
    // main function.
    //
    // Note that we must copy argument string values since we will rewrite the
    // entire argument block when we apply the nice name to argv0.
    //
    // As an exception to the above rule, anything in "spaced commands"
    // goes to the vm even though it has a space in it.
    const char* spaced_commands[] = { "-cp", "-classpath" };
    // Allow "spaced commands" to be succeeded by exactly 1 argument (regardless of -s).
    bool known_command = false;

    int i;
    for (i = 0; i &lt; argc; i++) {
        if (known_command == true) {
          runtime.addOption(strdup(argv[i]));
          // The static analyzer gets upset that we don't ever free the above
          // string. Since the allocation is from main, leaking it doesn't seem
          // problematic. NOLINTNEXTLINE
          ALOGV("app_process main add known option '%s'", argv[i]);
          known_command = false;
          continue;
        }

        for (int j = 0;
             j &lt; static_cast&lt;int&gt;(sizeof(spaced_commands) / sizeof(spaced_commands[0]));
             ++j) {
          if (strcmp(argv[i], spaced_commands[j]) == 0) {
            known_command = true;
            ALOGV("app_process main found known command '%s'", argv[i]);
          }
        }

        if (argv[i][0] != '-') {
            break;
        }
        if (argv[i][1] == '-' &amp;&amp; argv[i][2] == 0) {
            ++i; // Skip --.
            break;
        }

        runtime.addOption(strdup(argv[i]));
        // The static analyzer gets upset that we don't ever free the above
        // string. Since the allocation is from main, leaking it doesn't seem
        // problematic. NOLINTNEXTLINE
        ALOGV("app_process main add option '%s'", argv[i]);
    }

    // Parse runtime arguments.  Stop at first unrecognized option.
    bool zygote = false;
    bool startSystemServer = false;
    bool application = false;
    String8 niceName;
    String8 className;

    ++i;  // Skip unused "parent dir" argument.
    while (i &lt; argc) {
        const char* arg = argv[i++];
        if (strcmp(arg, "--zygote") == 0) {
            zygote = true;
            niceName = ZYGOTE_NICE_NAME;
        } else if (strcmp(arg, "--start-system-server") == 0) {
            startSystemServer = true;
        } else if (strcmp(arg, "--application") == 0) {
            application = true;
        } else if (strncmp(arg, "--nice-name=", 12) == 0) {
            niceName.setTo(arg + 12);
        } else if (strncmp(arg, "--", 2) != 0) {
            className.setTo(arg);
            break;
        } else {
            --i;
            break;
        }
    }

    Vector&lt;String8&gt; args;
    if (!className.isEmpty()) {
        // We're not in zygote mode, the only argument we need to pass
        // to RuntimeInit is the application argument.
        //
        // The Remainder of args get passed to startup class main(). Make
        // copies of them before we overwrite them with the process name.
        args.add(application ? String8("application") : String8("tool"));
        runtime.setClassNameAndArgs(className, argc - i, argv + i);

        if (!LOG_NDEBUG) {
          String8 restOfArgs;
          char* const* argv_new = argv + i;
          int argc_new = argc - i;
          for (int k = 0; k &lt; argc_new; ++k) {
            restOfArgs.append("\"");
            restOfArgs.append(argv_new[k]);
            restOfArgs.append("\" ");
          }
          ALOGV("Class name = %s, args = %s", className.string(), restOfArgs.string());
        }
    } else {
        // We're in zygote mode.
        maybeCreateDalvikCache();

        if (startSystemServer) {
            args.add(String8("start-system-server"));
        }

        char prop[PROP_VALUE_MAX];
        if (property_get(ABI_LIST_PROPERTY, prop, NULL) == 0) {
            LOG_ALWAYS_FATAL("app_process: Unable to determine ABI list from property %s.",
                ABI_LIST_PROPERTY);
            return 11;
        }

        String8 abiFlag("--abi-list=");
        abiFlag.append(prop);
        args.add(abiFlag);

        // In zygote mode, pass all remaining arguments to the zygote
        // main() method.
        for (; i &lt; argc; ++i) {
            args.add(String8(argv[i]));
        }
    }

    if (!niceName.isEmpty()) {
        runtime.setArgv0(niceName.string(), true /* setProcName */);
    }

    if (zygote) {
        // frameworks/base/core/jni/AndroidRuntime.cpp start()
        runtime.start("com.android.internal.os.ZygoteInit", args, zygote);//注意这里是去启动 ZygoteInit的main 函数
    } else if (className) {
        runtime.start("com.android.internal.os.RuntimeInit", args, zygote);
    } else {
        fprintf(stderr, "Error: no class name or --zygote supplied.\n");
        app_usage();
        LOG_ALWAYS_FATAL("app_process: no class name or --zygote supplied.");
    }
}

&gt; Note: runtime 的 start方法里会去调用startReg()方法去动态注册Framework里的JNI函数。

</pre></table></code></div></div><h2 id="4-zygote-的第二个门户--zygoteinit">4. Zygote 的第二个门户 —— ZygoteInit</h2><blockquote><p>根据 main 函数的执行过程，可以将main函数分为两部分：</p><ul><li>zygote 启动的 Mark 阶段。<li>systemserver 的创建。</ul></blockquote><h3 id="41-zygote的-mark-阶段">4.1 Zygote的 Mark 阶段</h3><p>这里总结 Mark 阶段总共六个步骤：</p><ol><li>通过 ZygoteHooks 的 startZygoteNoThreadCreation 与虚拟机建立连接，标记zygote启动。<li>通过Os.setpgid(0, 0)将Zygote加入自己的进程组,第一个0表示当前进程。<li>Zygote Init 之前的准备工作，如激活Ddms RuntimeInit.preForkInit();<li>解析main 函数的参数。<li>通过gcAndFinalize()进行一次gc处理<li>Zygote 的 Native 层的初始化——Zygote.initNativeState(isPrimaryZygote)。</ol><blockquote><p>在初始化 zygote 的 Native 状态时，首先会去查找环境变量”ANDROID_SOCKET_zygote”,并将找到的值通过atoi()转换成int类型的文件描述符，如果该环境变量为空，就会通过initUnsolSocketToSystemServer()函数去创建一个socket。最后就是检测selinux 权限并初始化selinux 上下文。</p></blockquote><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c1">//文件路径： frameworks/base/core/java/com/android/internal/os/Zygote.java</span>
    <span class="cm">/**
     * Initialize the native state of the Zygote.  This inclues
     *   - Fetching socket FDs from the environment
     *   - Initializing security properties
     *   - Unmounting storage as appropriate
     *   - Loading necessary performance profile information
     *
     * @param isPrimary  True if this is the zygote process, false if it is zygote_secondary
     */</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">initNativeState</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">isPrimary</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">nativeInitNativeState</span><span class="o">(</span><span class="n">isPrimary</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><div class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
</pre><td class="rouge-code"><pre>
<span class="c1">//文件路径： frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</span>

<span class="cm">/**
 * The prefix string for environmental variables storing socket FDs created by
 * init.
 */</span>

<span class="k">static</span> <span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="n">string_view</span> <span class="nf">ANDROID_SOCKET_PREFIX</span><span class="p">(</span><span class="s">"ANDROID_SOCKET_"</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">com_android_internal_os_Zygote_nativeInitNativeState</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jclass</span><span class="p">,</span><span class="n">jboolean</span> <span class="n">is_prima</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/*
   * Obtain file descriptors created by init from the environment.
   */</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">android_socket_prefix</span><span class="p">(</span><span class="n">ANDROID_SOCKET_PREFIX</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">env_var_name</span> <span class="o">=</span> <span class="n">android_socket_prefix</span> <span class="o">+</span> <span class="p">(</span><span class="n">is_primary</span> <span class="o">?</span> <span class="s">"zygote"</span> <span class="o">:</span> <span class="s">"zygote_secondary"</span><span class="p">);</span>
  <span class="kt">char</span><span class="o">*</span> <span class="n">env_var_val</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="n">env_var_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">env_var_val</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gZygoteSocketFD</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">env_var_val</span><span class="p">);</span>
    <span class="n">ALOGV</span><span class="p">(</span><span class="s">"Zygote:zygoteSocketFD = %d"</span><span class="p">,</span> <span class="n">gZygoteSocketFD</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Unable to fetch Zygote socket file descriptor"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">env_var_name</span> <span class="o">=</span> <span class="n">android_socket_prefix</span> <span class="o">+</span> <span class="p">(</span><span class="n">is_primary</span> <span class="o">?</span> <span class="s">"usap_pool_primary"</span> <span class="o">:</span> <span class="s">"usap_pool_secondary"</span><span class="p">);</span>
  <span class="n">env_var_val</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="n">env_var_name</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">env_var_val</span> <span class="o">!=</span> <span class="nb">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">gUsapPoolSocketFD</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">env_var_val</span><span class="p">);</span>
    <span class="n">ALOGV</span><span class="p">(</span><span class="s">"Zygote:usapPoolSocketFD = %d"</span><span class="p">,</span> <span class="n">gUsapPoolSocketFD</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Unable to fetch USAP pool socket file descriptor"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">initUnsolSocketToSystemServer</span><span class="p">();</span>
  <span class="cm">/*
   * Security Initialization
   */</span>

  <span class="c1">// security_getenforce is not allowed on app process. Initialize and cache</span>
  <span class="c1">// the value before zygote forks.</span>
  <span class="n">gIsSecurityEnforced</span> <span class="o">=</span> <span class="n">security_getenforce</span><span class="p">();</span>

  <span class="n">selinux_android_seapp_context_init</span><span class="p">();</span>

  <span class="cm">/*
   * Storage Initialization
   */</span>

  <span class="n">UnmountStorageOnInit</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>

  <span class="cm">/*
   * Performance Initialization
   */</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">SetTaskProfiles</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{}))</span> <span class="p">{</span>
    <span class="n">ZygoteFailure</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">"zygote"</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="s">"Zygote SetTaskProfiles failed"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Create the socket which is going to be used to send unsolicited message</span>
<span class="c1">// to system_server, the socket will be closed post forking a child process.</span>
<span class="c1">// It's expected to be called at each zygote's initialization.</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">initUnsolSocketToSystemServer</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">gSystemServerSocketFd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_LOCAL</span><span class="p">,</span> <span class="n">SOCK_DGRAM</span> <span class="o">|</span> <span class="n">SOCK_NONBLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">gSystemServerSocketFd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ALOGV</span><span class="p">(</span><span class="s">"Zygote:systemServerSocketFD = %d"</span><span class="p">,</span> <span class="n">gSystemServerSocketFd</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">ALOGE</span><span class="p">(</span><span class="s">"Unable to create socket file descriptor to connect to system_server"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><h3 id="42-systemserver的创建">4.2 SystemServer的创建</h3><p>ZygoteInit 只是systemserve创建的发起者，创建systemserver启动的核心成员ZygoteServer和ZygoteArguments，然后由Zygote.java 的nativeForkSystemServer()去实施fork并返回子进程pid。</p><ol><li>ZygoteServer 初始化</ol><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="nc">ZygoteServer</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">isPrimaryZygote</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mUsapPoolEventFD</span> <span class="o">=</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">getUsapPoolEventFD</span><span class="o">();</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">isPrimaryZygote</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//根据环境变量 ANDROID_SOCKET_zygote 获取socket文件句柄。</span>
        <span class="n">mZygoteSocket</span> <span class="o">=</span>  <span class="nc">Zygote</span><span class="o">.</span><span class="na">createManagedSocketFromInitSocket</span><span class="o">(</span>
                         <span class="nc">Zygote</span><span class="o">.</span><span class="na">PRIMARY_SOCKET_NAME</span><span class="o">);</span>
        <span class="c1">//根据环境变量 ANDROID_SOCKET_usap_pool_primary 获取usap_pool_primary句柄</span>
        <span class="n">mUsapPoolSocket</span> <span class="o">=</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">createManagedSocketFromInitSocket</span><span class="o">(</span>
                         <span class="nc">Zygote</span><span class="o">.</span><span class="na">USAP_POOL_PRIMARY_SOCKET_NAME</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">mZygoteSocket</span> <span class="o">=</span> <span class="nc">Zygote</span><span class="o">.</span><span class="na">createManagedSocketFromInitSocket</span><span class="o">(</span>
                         <span class="nc">Zygote</span><span class="o">.</span><span class="na">SECONDARY_SOCKET_NAME</span><span class="o">);</span>
        <span class="n">mUsapPoolSocket</span> <span class="o">=</span>
                <span class="nc">Zygote</span><span class="o">.</span><span class="na">createManagedSocketFromInitSocket</span><span class="o">(</span>
                            <span class="nc">Zygote</span><span class="o">.</span><span class="na">USAP_POOL_SECONDARY_SOCKET_NAME</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">mUsapPoolSupported</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">fetchUsapPoolPolicyProps</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
     * Creates a managed LocalServerSocket object using a file descriptor
     * created by an init.rc script.  The init scripts that specify the
     * sockets name can be found in system/core/rootdir.  The socket is bound
     * to the file system in the /dev/sockets/ directory, and the file
     * descriptor is shared via the ANDROID_SOCKET_&lt;socketName&gt; environment
     * variable.
     */</span>
    <span class="kd">static</span> <span class="nc">LocalServerSocket</span> <span class="nf">createManagedSocketFromInitSocket</span><span class="o">(</span><span class="nc">String</span> <span class="n">socketName</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">fileDesc</span><span class="o">;</span>
        <span class="kd">final</span> <span class="nc">String</span> <span class="n">fullSocketName</span> <span class="o">=</span> <span class="no">ANDROID_SOCKET_PREFIX</span> <span class="o">+</span> <span class="n">socketName</span><span class="o">;</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">String</span> <span class="n">env</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="n">fullSocketName</span><span class="o">);</span>
            <span class="n">fileDesc</span> <span class="o">=</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">env</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">RuntimeException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Socket unset or invalid: "</span> <span class="o">+</span> <span class="n">fullSocketName</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">FileDescriptor</span> <span class="n">fd</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileDescriptor</span><span class="o">();</span>
            <span class="n">fd</span><span class="o">.</span><span class="na">setInt</span><span class="err">$</span><span class="o">(</span><span class="n">fileDesc</span><span class="o">);</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nf">LocalServerSocket</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                <span class="s">"Error building socket from file descriptor: "</span> <span class="o">+</span> <span class="n">fileDesc</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><ol><li>ZygoteArguments 的创建</ol><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="cm">/* Hardcoded command line to start the system server */</span>
<span class="nc">String</span> <span class="n">args</span><span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
    <span class="s">"--setuid=1000"</span><span class="o">,</span>
    <span class="s">"--setgid=1000"</span><span class="o">,</span>
    <span class="s">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,"</span>
        <span class="o">+</span> <span class="s">"1024,1032,1065,3001,3002,3003,3006,3007,3009,3010,3011"</span><span class="o">,</span>
    <span class="s">"--capabilities="</span> <span class="o">+</span> <span class="n">capabilities</span> <span class="o">+</span> <span class="s">","</span> <span class="o">+</span> <span class="n">capabilities</span><span class="o">,</span>
    <span class="s">"--nice-name=system_server"</span><span class="o">,</span>
    <span class="s">"--runtime-args"</span><span class="o">,</span>
    <span class="s">"--target-sdk-version="</span> <span class="o">+</span> <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">SDK_VERSION_CUR_DEVELOPMENT</span><span class="o">,</span>
    <span class="s">"com.android.server.SystemServer"</span><span class="o">,</span>
    <span class="o">};</span>
</pre></table></code></div></div><ol><li>委托 Zygote 创建进程并返回进程ID</ol><p>父进程中返回的是子进程ID，子进程中返回pid = 0。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkSystemServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">runtimeFlags</span><span class="o">,</span>
            <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">long</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="kt">long</span> <span class="n">effectiveCapabilities</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ZygoteHooks</span><span class="o">.</span><span class="na">preFork</span><span class="o">();</span>

        <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkSystemServer</span><span class="o">(</span>
                <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">runtimeFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span>
                <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="n">effectiveCapabilities</span><span class="o">);</span>

        <span class="c1">// Set the Java Language thread priority to the default value for new apps.</span>
        <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setPriority</span><span class="o">(</span><span class="nc">Thread</span><span class="o">.</span><span class="na">NORM_PRIORITY</span><span class="o">);</span>

        <span class="nc">ZygoteHooks</span><span class="o">.</span><span class="na">postForkCommon</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
    <span class="o">}</span>
</pre></table></code></div></div><ol><li>关闭子进程中的 socket 文件句柄。</ol><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>        <span class="cm">/* For child process */</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">hasSecondZygote</span><span class="o">(</span><span class="n">abiList</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">waitForSecondaryZygote</span><span class="o">(</span><span class="n">socketName</span><span class="o">);</span>
            <span class="o">}</span>

            <span class="n">zygoteServer</span><span class="o">.</span><span class="na">closeServerSocket</span><span class="o">();</span>
            <span class="c1">//子进程返回 runable 接口</span>
            <span class="k">return</span> <span class="nf">handleSystemServerProcess</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">//父进程返回空。</span>
        <span class="k">return</span> <span class="kc">null</span>
</pre></table></code></div></div><ol><li>子进程中的 handleSystemServerProcess</ol><p>创建Binder线程，创建main 函数的反射runable 接口。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
</pre><td class="rouge-code"><pre><span class="cm">/**
     * Finish remaining work for the newly forked system server process.
     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="nc">Runnable</span> <span class="nf">handleSystemServerProcess</span><span class="o">(</span><span class="nc">ZygoteArguments</span> <span class="n">parsedArgs</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// set umask to 0077 so new files and directories will default to owner-only permissions.</span>
        <span class="nc">Os</span><span class="o">.</span><span class="na">umask</span><span class="o">(</span><span class="no">S_IRWXG</span> <span class="o">|</span> <span class="no">S_IRWXO</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">Process</span><span class="o">.</span><span class="na">setArgV0</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mNiceName</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="kd">final</span> <span class="nc">String</span> <span class="n">systemServerClasspath</span> <span class="o">=</span> <span class="nc">Os</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">"SYSTEMSERVERCLASSPATH"</span><span class="o">);</span>
        <span class="o">...</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mInvokeWith</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">...</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="nc">ClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">systemServerClasspath</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">cl</span> <span class="o">=</span> <span class="n">createPathClassLoader</span><span class="o">(</span><span class="n">systemServerClasspath</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mTargetSdkVersion</span><span class="o">);</span>

                <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="cm">/*
             * Pass the remaining arguments to SystemServer.
             */</span>
            <span class="k">return</span> <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">zygoteInit</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">mTargetSdkVersion</span><span class="o">,</span>
                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mDisabledCompatChanges</span><span class="o">,</span>
                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mRemainingArgs</span><span class="o">,</span> <span class="n">cl</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="cm">/* should never reach here */</span>
    <span class="o">}</span>

    <span class="cm">/**
     * The main function called when started through the zygote process. This could be unified with
     * main(), if the native code in nativeFinishInit() were rationalized with Zygote startup.&lt;p&gt;
     *
     * Current recognized args:
     * &lt;ul&gt;
     * &lt;li&gt; &lt;code&gt; [--] &amp;lt;start class name&amp;gt;  &amp;lt;args&amp;gt;
     * &lt;/ul&gt;
     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Runnable</span> <span class="nf">zygoteInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">disabledCompatChanges</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="nc">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">,</span> <span class="s">"ZygoteInit"</span><span class="o">);</span>
        <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">redirectLogStreams</span><span class="o">();</span>

        <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">commonInit</span><span class="o">();</span>
        <span class="nc">ZygoteInit</span><span class="o">.</span><span class="na">nativeZygoteInit</span><span class="o">();</span><span class="c1">//创建Binder线程池，用于Binder通信</span>
        <span class="k">return</span> <span class="nc">RuntimeInit</span><span class="o">.</span><span class="na">applicationInit</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">disabledCompatChanges</span><span class="o">,</span> <span class="n">argv</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">protected</span> <span class="kd">static</span> <span class="nc">Runnable</span> <span class="nf">applicationInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="kt">long</span><span class="o">[]</span> <span class="n">disabledCompatChanges</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span> <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// If the application calls System.exit(), terminate the process</span>
        <span class="c1">// immediately without running any shutdown hooks.  It is not possible to</span>
        <span class="c1">// shutdown an Android application gracefully.  Among other things, the</span>
        <span class="c1">// Android runtime shutdown hooks close the Binder driver, which can cause</span>
        <span class="c1">// leftover running threads to crash before the process actually exits.</span>
        <span class="n">nativeSetExitWithoutCleanup</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

        <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setTargetSdkVersion</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">);</span>
        <span class="nc">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">setDisabledCompatChanges</span><span class="o">(</span><span class="n">disabledCompatChanges</span><span class="o">);</span>

        <span class="kd">final</span> <span class="nc">Arguments</span> <span class="n">args</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Arguments</span><span class="o">(</span><span class="n">argv</span><span class="o">);</span>

        <span class="c1">// The end of of the RuntimeInit event (see #zygoteInit).</span>
        <span class="nc">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="nc">Trace</span><span class="o">.</span><span class="na">TRACE_TAG_ACTIVITY_MANAGER</span><span class="o">);</span>

        <span class="c1">// Remaining arguments are passed to the start class's static main</span>
        <span class="k">return</span> <span class="nf">findStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="cm">/**
     * Invokes a static "main(argv[]) method on class "className".
     * Converts various failing exceptions into RuntimeExceptions, with
     * the assumption that they will then cause the VM instance to exit.
     */</span>
    <span class="kd">protected</span> <span class="kd">static</span> <span class="nc">Runnable</span> <span class="nf">findStaticMain</span><span class="o">(</span><span class="nc">String</span> <span class="n">className</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">,</span>
            <span class="nc">ClassLoader</span> <span class="n">classLoader</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">cl</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">cl</span> <span class="o">=</span> <span class="nc">Class</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">className</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">classLoader</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">ClassNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{}</span>

        <span class="nc">Method</span> <span class="n">m</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">"main"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="nc">String</span><span class="o">[].</span><span class="na">class</span> <span class="o">});</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NoSuchMethodException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{}</span>
        <span class="kt">int</span> <span class="n">modifiers</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">();</span>
        <span class="cm">/*
         * This throw gets caught in ZygoteInit.main(), which responds
         * by invoking the exception's run() method. This arrangement
         * clears up all the stack frames that were required in setting
         * up the process.
         */</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">MethodAndArgsCaller</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
    <span class="o">}</span>

<span class="cm">/**
     * Helper class which holds a method and arguments and can call them. This is used as part of
     * a trampoline to get rid of the initial process setup stack frames.
     */</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">MethodAndArgsCaller</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="cm">/** method to call */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Method</span> <span class="n">mMethod</span><span class="o">;</span>

        <span class="cm">/** argument array */</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">mArgs</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">MethodAndArgsCaller</span><span class="o">(</span><span class="nc">Method</span> <span class="n">method</span><span class="o">,</span> <span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mMethod</span> <span class="o">=</span> <span class="n">method</span><span class="o">;</span>
            <span class="n">mArgs</span> <span class="o">=</span> <span class="n">args</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">mMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">mArgs</span> <span class="o">});</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IllegalAccessException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><ol><li>zygote循环监听socket文件变化</ol><p>创建出systemserver 子进程后，由于systemserver 子进程返回的是非空runable,父进程zygote返回是null,所以子进程会执行run()方法然后return结束。父进程会执行zygoteServer.runSelectLoop(abiList);</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">startSystemServer</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="n">forkSystemServer</span><span class="o">(</span><span class="n">abiList</span><span class="o">,</span> <span class="n">zygoteSocketName</span><span class="o">,</span> <span class="n">zygoteServer</span><span class="o">);</span>

        <span class="c1">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
        <span class="c1">// child (system_server) process.</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="nc">Log</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"Accepting command socket connections"</span><span class="o">);</span>

    <span class="c1">// The select loop returns early in the child process after a fork and</span>
    <span class="c1">// loops forever in the zygote.</span>
    <span class="n">caller</span> <span class="o">=</span> <span class="n">zygoteServer</span><span class="o">.</span><span class="na">runSelectLoop</span><span class="o">(</span><span class="n">abiList</span><span class="o">);</span>
    <span class="c1">// We're in the child process and have exited the select loop. Proceed to execute the</span>
    <span class="c1">// command.</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">caller</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">caller</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>runSelectLoop 会去监听两个socket（init.zygote64.rc中的socket）文件句柄的变化，通过acceptCommandPeer()创建socket的接收端ZygoteConnection,一旦文件句柄发生变化就会由ZygoteConnection的processOneCommand(this)来处理。</p><p>在processOneCommand方法中通过Zygote.forkAndSpecialize()去处理子进程的创建，通过handleChildProc -&gt; ZygoteInit.zygoteInit 构建main 函数的反射函数的runable 接口，一路返回到ZygoteInit的man函数，由于父进程得到的返回是null，子进程不为空，才会去执行的runable的run 方法，calss的main函数就会被执行到，例如应用创建时的ActivityThread.main()。</p><h2 id="5-总结">5. 总结</h2><p>ZygoteInit 做初始化 Zygote 用于native层交流 ZygoteServer 永来管理socket ZygoteConnection 用来接收socket消息并处理。</p><p>用了一张图片来总结</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/res/picture/zygote启动.jpg" alt="图2" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android/'>Android</a>, <a href='/categories/framework/'>Framework</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/framework/" class="post-tag no-text-decoration" >Framework</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=深入理解 AndroidFramework 之 Zygote 启动 - SunMoon&url=https://dongxiaofat.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Zygote-%E5%90%AF%E5%8A%A8/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=深入理解 AndroidFramework 之 Zygote 启动 - SunMoon&u=https://dongxiaofat.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Zygote-%E5%90%AF%E5%8A%A8/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=深入理解 AndroidFramework 之 Zygote 启动 - SunMoon&url=https://dongxiaofat.github.io/posts/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Zygote-%E5%90%AF%E5%8A%A8/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/text-and-typography/">Text and Typography</a><li><a href="/posts/customize-the-favicon/">Customize the Favicon</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/framework/">Framework</a> <a class="post-tag" href="/tags/favicon/">favicon</a> <a class="post-tag" href="/tags/typography/">typography</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/AndroidFont/"><div class="card-body"> <span class="timeago small" > Feb 16 <i class="unloaded">2021-02-16T16:30:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>深入理解Android Font 机制</h3><div class="text-muted small"><p> 深入理解Android Font 机制 Android 字体是由配置好的ttf字体文件来描述的，然而在字体加载的过程中首先就是根据字符去匹配相应的ttf文件，然后在该ttf文件中依照Unicode编码查找字符形状进行描绘。 Unicode编码 Unicode 规范规定，使用U+前缀加上一个十六进制的整数表示一个字符，比如U+0041表示大写拉丁字母A。而整个Unicode的字符集...</p></div></div></a></div><div class="card"> <a href="/posts/Android-oom-adj/"><div class="card-body"> <span class="timeago small" > Feb 26 <i class="unloaded">2021-02-26T08:45:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android OOM Low Memory Killer 机制</h3><div class="text-muted small"><p> Android OOM Low Memory Killer 机制 本文主要介绍Android的low memory killer的 oom_adj的相关概念，以及根据一些案例来阐述了解oom_adj对于做Android应用开发的重要意义。 1. Low Memory Killer中进程的分类以及各类进程的adj值 在Android的low memroy killer机制中，会对于所...</p></div></div></a></div><div class="card"> <a href="/posts/SurfaceFlinger-HWComposer/"><div class="card-body"> <span class="timeago small" > Feb 26 <i class="unloaded">2021-02-26T12:45:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SurfaceFlinger 之 HWComposer</h3><div class="text-muted small"><p> SurfaceFlinger 之 HWComposer HWC（hwcomposer）是Android中进行窗口（Layer）合成和显示的HAL层模块，其实现是特定于设备的，而且通常由显示设备制造商 (OEM)完成，为SurfaceFlinger服务提供硬件支持。 SurfaceFlinger可以使用OpenGL ES合成Layer，这需要占用并消耗GPU资源。大多数GPU...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/AndroidFont/" class="btn btn-outline-primary" prompt="Older"><p>深入理解Android Font 机制</p></a> <a href="/posts/Android-oom-adj/" class="btn btn-outline-primary" prompt="Newer"><p>Android OOM Low Memory Killer 机制</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://gitee.com/DongXiaoFat">DongChunYang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/framework/">Framework</a> <a class="post-tag" href="/tags/favicon/">favicon</a> <a class="post-tag" href="/tags/typography/">typography</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://dongxiaofat.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
